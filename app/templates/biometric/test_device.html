{% extends "base.html" %}

{% block title %}Test Fingerprint Device - School Management System{% endblock %}

{% block extra_css %}
<style>
    .device-status {
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .device-connected {
        background-color: #d1e7dd;
        border: 1px solid #badbcc;
        color: #0f5132;
    }
    
    .device-disconnected {
        background-color: #f8d7da;
        border: 1px solid #f5c2c7;
        color: #842029;
    }
    
    .device-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .device-info {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
    }
    
    .device-info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .device-info-item:last-child {
        border-bottom: none;
    }
    
    .device-info-label {
        font-weight: bold;
    }
    
    .troubleshooting-steps {
        margin-top: 2rem;
    }
    
    .step {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .step-number {
        display: inline-block;
        width: 30px;
        height: 30px;
        background-color: #0d6efd;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 30px;
        margin-right: 0.5rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-lg-row">
   <!-- Sidebar -->
   <div class="sidebar">
       <div class="p-3 border-bottom">
           <h4 class="mb-0">School Management</h4>
           <small>{{ current_user.role.capitalize() }} Dashboard</small>
       </div>
       <div class="mt-3">
           {% if current_user.role == 'admin' %}
               <a href="{{ url_for('admin.dashboard') }}" class="sidebar-link">
                   <i class="fas fa-tachometer-alt me-2"></i> Dashboard
               </a>
           {% elif current_user.role == 'lecturer' %}
               <a href="{{ url_for('lecturer.dashboard') }}" class="sidebar-link">
                   <i class="fas fa-tachometer-alt me-2"></i> Dashboard
               </a>
           {% elif current_user.role == 'class_rep' %}
               <a href="{{ url_for('class_rep.dashboard') }}" class="sidebar-link">
                   <i class="fas fa-tachometer-alt me-2"></i> Dashboard
               </a>
           {% endif %}
           
           <a href="{{ url_for('calendar.index') }}" class="sidebar-link">
               <i class="fas fa-calendar-alt me-2"></i> Calendar
           </a>
           
           <a href="{{ url_for('profile.index') }}" class="sidebar-link">
               <i class="fas fa-user-cog me-2"></i> Profile
           </a>
           
           <a href="{{ url_for('biometric.enroll') }}" class="sidebar-link">
               <i class="fas fa-fingerprint me-2"></i> Fingerprint Enrollment
           </a>
           
           <a href="{{ url_for('biometric.test_device') }}" class="sidebar-link active">
               <i class="fas fa-tools me-2"></i> Test Device
           </a>
           
           <a href="{{ url_for('auth.logout') }}" class="sidebar-link mt-5">
               <i class="fas fa-sign-out-alt me-2"></i> Logout
           </a>
       </div>
   </div>

   <!-- Main Content -->
   <div class="main-content">
       {% with messages = get_flashed_messages() %}
           {% if messages %}
               {% for message in messages %}
                   <div class="alert alert-success alert-dismissible fade show" role="alert">
                       {{ message }}
                       <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                   </div>
               {% endfor %}
           {% endif %}
       {% endwith %}

       <h2 class="mb-4">Fingerprint Device Test</h2>
       
       <div class="card card-dashboard mb-4">
           <div class="card-header bg-primary text-white">
               <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Device Status</h5>
           </div>
           <div class="card-body">
               {% if connected %}
                   <div class="device-status device-connected">
                       <div class="device-icon">
                           <i class="fas fa-fingerprint"></i>
                       </div>
                       <h3>Device Connected</h3>
                       <p>{{ message }}</p>
                   </div>
                   
                   <h4>Device Information</h4>
                   <div class="device-info">
                       <div class="device-info-item">
                           <span class="device-info-label">Device Name:</span>
                           <span>{{ device_info.name }}</span>
                       </div>
                       <div class="device-info-item">
                           <span class="device-info-label">Vendor ID:</span>
                           <span>0x{{ '%04x'|format(device_info.vendor_id) }}</span>
                       </div>
                       <div class="device-info-item">
                           <span class="device-info-label">Product ID:</span>
                           <span>0x{{ '%04x'|format(device_info.product_id) }}</span>
                       </div>
                       <div class="device-info-item">
                           <span class="device-info-label">Firmware Version:</span>
                           <span>{{ device_info.firmware_version }}</span>
                       </div>
                       <div class="device-info-item">
                           <span class="device-info-label">Serial Number:</span>
                           <span>{{ device_info.serial_number }}</span>
                       </div>
                       <div class="device-info-item">
                           <span class="device-info-label">Driver Version:</span>
                           <span>{{ device_info.driver_version }}</span>
                       </div>
                   </div>
                   
                   <div class="d-grid gap-2 mt-4">
                       <button id="testCaptureBtn" class="btn btn-success">
                           <i class="fas fa-fingerprint me-2"></i>Test Fingerprint Capture
                       </button>
                       <a href="{{ url_for('biometric.enroll') }}" class="btn btn-primary">
                           <i class="fas fa-user-plus me-2"></i>Proceed to Enrollment
                       </a>
                   </div>
                   
                   <div id="captureResult" class="mt-4" style="display: none;"></div>
               {% else %}
                   <div class="device-status device-disconnected">
                       <div class="device-icon">
                           <i class="fas fa-exclamation-triangle"></i>
                       </div>
                       <h3>Device Not Connected</h3>
                       <p>{{ message }}</p>
                   </div>
                   
                   <h4>Troubleshooting Steps</h4>
                   <div class="troubleshooting-steps">
                       <div class="step">
                           <span class="step-number">1</span>
                           <strong>Check Physical Connection</strong>
                           <p>Ensure the HID Digital Persona 4500 is properly connected to a USB port on your computer.</p>
                       </div>
                       <div class="step">
                           <span class="step-number">2</span>
                           <strong>Verify Driver Installation</strong>
                           <p>Make sure the correct drivers are installed for your operating system:</p>
                           <ul>
                               <li>Windows: Check Device Manager for any devices with warning icons</li>
                               <li>Linux: Run <code>lsusb</code> to verify the device is detected</li>
                               <li>macOS: Check System Information > USB to verify the device is detected</li>
                           </ul>
                       </div>
                       <div class="step">
                           <span class="step-number">3</span>
                           <strong>Install Required Drivers</strong>
                           <p>Download and install the latest drivers for the HID Digital Persona 4500:</p>
                           <ul>
                               <li>Windows: <a href="https://www.hidglobal.com/drivers" target="_blank">HID Global Driver Download</a></li>
                               <li>Linux: Install the libfprint and fprintd packages</li>
                               <li>macOS: Install the HID Global driver package</li>
                           </ul>
                       </div>
                       <div class="step">
                           <span class="step-number">4</span>
                           <strong>Restart the Application</strong>
                           <p>After installing drivers, restart the application and try again.</p>
                       </div>
                   </div>
                   
                   <div class="d-grid gap-2 mt-4">
                       <a href="{{ url_for('biometric.test_device') }}" class="btn btn-primary">
                           <i class="fas fa-sync-alt me-2"></i>Retry Connection
                       </a>
                       <a href="https://www.hidglobal.com/support" target="_blank" class="btn btn-outline-secondary">
                           <i class="fas fa-external-link-alt me-2"></i>Visit HID Support
                       </a>
                   </div>
               {% endif %}
           </div>
       </div>
       
       <div class="card card-dashboard">
           <div class="card-header bg-info text-white">
               <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>About HID Digital Persona 4500</h5>
           </div>
           <div class="card-body">
               <div class="row">
                   <div class="col-md-4 text-center mb-3 mb-md-0">
                       <img src="/placeholder.svg?height=200&width=200" alt="HID Digital Persona 4500" class="img-fluid rounded">
                   </div>
                   <div class="col-md-8">
                       <h5>HID Digital Persona 4500 Fingerprint Reader</h5>
                       <p>The Digital Persona 4500 is a high-performance optical fingerprint reader designed for use in various applications including:</p>
                       <ul>
                           <li>Time and attendance systems</li>
                           <li>Access control</li>
                           <li>Identity verification</li>
                       </ul>
                       <p>Features:</p>
                       <ul>
                           <li>Blue LED illumination technology for enhanced image quality</li>
                           <li>Patented optical design for superior image quality</li>
                           <li>Rugged design with hard glass platen</li>
                           <li>Encrypted fingerprint data for secure transmission</li>
                           <li>Compatible with Windows, Linux, and Android</li>
                           <li>USB 2.0 interface for easy connectivity</li>
                           <li>500 DPI resolution for accurate fingerprint capture</li>
                           <li>Built-in latent fingerprint rejection</li>
                       </ul>
                       
                       <p>System Requirements:</p>
                       <ul>
                           <li>Windows 7/8/10/11 (32-bit or 64-bit)</li>
                           <li>Linux (kernel 2.6 or later)</li>
                           <li>macOS 10.12 or later</li>
                           <li>USB 2.0 port</li>
                           <li>50MB free disk space for driver installation</li>
                       </ul>
                   </div>
               </div>
           </div>
       </div>
   </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
   document.addEventListener('DOMContentLoaded', function() {
       const testCaptureBtn = document.getElementById('testCaptureBtn');
       const captureResult = document.getElementById('captureResult');
       
       if (testCaptureBtn) {
           testCaptureBtn.addEventListener('click', function() {
               // Show loading state
               testCaptureBtn.disabled = true;
               testCaptureBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Capturing...';
               captureResult.style.display = 'block';
               captureResult.innerHTML = '<div class="alert alert-info">Please place your finger on the scanner...</div>';
               
               // Call the capture endpoint
               fetch('{{ url_for("biometric.capture") }}', {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                   },
               })
               .then(response => response.json())
               .then(data => {
                   testCaptureBtn.disabled = false;
                   testCaptureBtn.innerHTML = '<i class="fas fa-fingerprint me-2"></i>Test Fingerprint Capture';
                   
                   if (data.success) {
                       captureResult.innerHTML = `
                           <div class="alert alert-success">
                               <h5><i class="fas fa-check-circle me-2"></i>Capture Successful</h5>
                               <p>Quality Score: ${data.quality}/100</p>
                               <p>Your fingerprint was successfully captured and processed.</p>
                           </div>
                       `;
                   } else {
                       captureResult.innerHTML = `
                           <div class="alert alert-danger">
                               <h5><i class="fas fa-exclamation-circle me-2"></i>Capture Failed</h5>
                               <p>${data.message}</p>
                               <p>Quality Score: ${data.quality || 'N/A'}</p>
                           </div>
                       `;
                   }
               })
               .catch(error => {
                   testCaptureBtn.disabled = false;
                   testCaptureBtn.innerHTML = '<i class="fas fa-fingerprint me-2"></i>Test Fingerprint Capture';
                   captureResult.innerHTML = `
                       <div class="alert alert-danger">
                           <h5><i class="fas fa-exclamation-circle me-2"></i>Error</h5>
                           <p>An error occurred while communicating with the server.</p>
                           <p>Error details: ${error.message}</p>
                       </div>
                   `;
               });
           });
       }
   });
</script>
{% endblock %}

